# Новостной портал с автоматической аналитикой

Этот проект представляет собой монорепозиторий для новостного портала с автоматическим сбором, анализом и публикацией материалов по темам **e‑commerce**, **IT** и **oil & gas**. Архитектура ориентирована на микросервисы и включает в себя очереди, нормализацию данных, LLM‑аналитику, расчёт надёжности, редакционный интерфейс, публикацию в CMS и дистрибуцию.

## Архитектура

Микросервисы (все находятся в этом монорепозитории):

- **gateway-api** — внешний REST API на FastAPI; предоставляет эндпоинты для запуска пайплайна и управления постами.
- **ingestor** — получение сырых данных от ресёрч‑провайдера (Perplexity).
- **normalizer** — очистка и нормализация текста, извлечение фактов.
- **deduper** — дедупликация новостей по шинглам/хешам.
- **fact-indexer** — запись фактов в Postgres и индекс в OpenSearch.
- **analyst** — аналитический модуль на GPT‑5 (в примере генерирует фиктивные данные).
- **verifier** — оценка надёжности (reliability score) и анти‑галлюцинации.
- **post-builder** — генерация длинной версии поста и краткой версии для Telegram.
- **publisher** — публикация в Ghost/WordPress и Telegram.
- **seo-distributor** — генерация sitemap, RSS/Atom, оповещение поисковиков.
- **reporter** — формирование ежедневных отчётов и алертов.
- **editor-console** — веб‑панель редактора на Next.js 14.

Связь между сервисами осуществляется через очереди Celery (Redis) и REST (gateway-api). Данные хранятся в PostgreSQL, поиск — в OpenSearch.

## Быстрый старт (Runbook)

1. **Клонируйте репозиторий** и перейдите в каталог `news_portal_monorepo`.
2. **Скопируйте файл конфигурации:**
   ```bash
   cp .env.example .env
   ```
   При необходимости измените значения переменных (ключи LLM, токены Telegram и т. п.).
3. **Запустите инфраструктуру локально** с помощью docker‑compose:
   ```bash
   docker-compose up --build
   ```
   Это поднимет Postgres, Redis, OpenSearch, gateway‑api, Celery worker, Next.js‑панель и Adminer.
4. **Примените миграции** (один раз):
   В новой вкладке терминала выполните:
   ```bash
   docker-compose exec gateway alembic upgrade head
   ```
5. **(Опционально) Засейте демо‑данные:**
   ```bash
   docker-compose exec gateway python scripts/seed_demo_data.py
   ```
   Это создаст по одному посту для каждой темы.
6. **Откройте интерфейсы:**
   - Gateway API — http://localhost:8000/docs (Swagger UI).
   - Консоль редактора — http://localhost:3000 (Next.js).
   - Adminer для просмотра БД — http://localhost:8080 (логин postgres/postgres).
7. **Типовой сценарий:** через API или консоль редактора запустите ingestion, затем постройте аналитику и пост, одобрите его и опубликуйте.
8. **Мониторинг:** Метрики Prometheus и дашборд Grafana вы можете настроить в сервисе `reporter` (пример конфигурации находится в `docs/grafana_dashboard.json`).

## Структура репозитория

Файлы и каталоги верхнего уровня:

- `gateway-api/` – FastAPI приложение.
- `ingestor/`, `normalizer/`, `deduper/`, `fact-indexer/`, `analyst/`, `verifier/`, `post-builder/`, `publisher/`, `seo-distributor/`, `reporter/` – каталоги микросервисов с Celery‑задачами.
- `editor-console/` – Next.js приложение для редакторов.
- `common/` – общие модули (БД, модели, Celery конфигурация).
- `alembic/` – миграции базы данных.
- `k8s/` – пример манифестов Kubernetes (Deployments, Services, Ingress).
- `docs/` – документация: OpenAPI, диаграммы Mermaid, описание очередей и статусов.
- `scripts/` – вспомогательные скрипты: `seed_demo_data.py`, `backfill_last_24h.py`.
- `docker-compose.yml` – локальный запуск всей системы.
- `.env.example` – пример переменных окружения.

## Дополнительно

* **LLM провайдеры:** в данном примере запросы к Perplexity и GPT‑5 заменены на генерацию фиктивных данных. Для подключения реальных провайдеров добавьте соответствующие API‑клиенты и шаблоны промптов (см. комментарии в коде `ingestor/tasks.py` и `analyst/tasks.py`).
* **Reliability score:** алгоритм оценки надёжности реализован в `verifier/tasks.py`. Компоненты S, C, T, M, F рассчитываются на основе простых эвристик и комбинируются по заданной формуле.
* **SEO и OG:** модуль `post-builder` генерирует базовые SEO‑метаданные и формирует HTML‑тело поста по шаблону.
* **Editor console:** Next.js‑приложение предоставляет список черновиков, просмотр деталей и действия “Одобрить” / “Опубликовать”. При необходимости можно расширить его функциями редактирования полей поста и историей правок.
* **Разворачивание в Kubernetes:** примеры манифестов находятся в каталоге `k8s/`. Для полноценного CI/CD можно настроить GitHub Actions, которые будут запускать линтеры, тесты, миграции и деплой.

## Лицензия

Этот проект предоставлен «как есть» исключительно в учебных целях.